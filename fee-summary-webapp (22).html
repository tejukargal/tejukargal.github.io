<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fee Summary Report Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f0f0f0;
            font-size: 14px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: left;
            font-size: 16px;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .filter-group {
            flex: 1;
            min-width: 150px;
            background-color: #f9f9f9;
            padding: 8px;
            border-radius: 5px;
        }
        .filter-group h3 {
            margin-top: 0;
            margin-bottom: 5px;
            color: #444;
            font-size: 14px;
        }
        .checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        .checkbox-item label {
            margin-left: 3px;
            font-size: 11px;
        }
        button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s, color 0.3s, font-weight 0.3s;
            margin-right: 10px;
        }
        #loadJson {
            background-color: #a8e6cf;
            color: #333;
        }
       #getSummary1, #getSummary2 {
        background-color: #99E6E6; /* Pastel Teal */
        color: #333;
        transition: background-color 0.3s, color 0.3s, font-weight 0.3s;
    }
    #getSummary1.active, #getSummary2.active {
        font-weight: bold;
        color: black;
    }
        #reset {
            background-color: #ffd3b6;
            color: #333;
        }
        #savePDF {
            background-color: #dcedc1;
            color: #333;
        }
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 11px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        th {
            background-color: #f2f2f2;
        }
        td.number {
            text-align: right;
        }
        tr.total-row {
            background-color: #ffe5d9;
            font-weight: bold;
        }
        #appliedFilters {
            margin-top: 15px;
            font-style: italic;
            font-size: 11px;
        }
        #totalRecords {
            margin-top: 8px;
            font-weight: bold;
            font-size: 11px;
        }
        #dateFilterContainer {
            display: none;
            margin-top: 10px;
        }
        #dateFilter {
            padding: 5px;
            font-size: 12px;
            border-radius: 3px;
            border: 1px solid #ddd;
            margin-left: 5px;
        }
        @media (max-width: 768px) {
            .filters-container {
                flex-direction: column;
            }
            table {
                font-size: 10px;
            }
            th, td {
                padding: 3px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="heading"></h1>
        <input type="file" id="jsonFile" accept=".json" style="display: none;">
        <button id="loadJson">Load JSON</button>
        <div id="totalRecords"></div>
        <div class="filters-container" id="filters"></div>
        <div id="dateFilterContainer">
            <label for="dateFilter">Date:</label>
            <select id="dateFilter"></select>
        </div>
        <div class="button-container">
            <div>
                <button id="getSummary1">Summary 1</button>
                <button id="getSummary2">Summary 2</button>
                <button id="savePDF">Save PDF</button>
            </div>
            <button id="reset">Reset</button>
        </div>
        <div id="appliedFilters"></div>
        <div id="summary"></div>
    </div>

    <script>
        let jsonData = [];
        let currentSummaryData = [];
        let currentSummaryType = 0;
        let filtersChanged = false;
        const filters = {
            Year: new Set(),
            Course: new Set(),
            'Adm Type': new Set(),
            'Adm Cat': new Set(),
            'Acdmc Year': new Set()
        };

        document.getElementById('loadJson').addEventListener('click', () => {
            document.getElementById('jsonFile').click();
        });

        document.getElementById('jsonFile').addEventListener('change', (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    jsonData = JSON.parse(e.target.result);
                    document.getElementById('totalRecords').textContent = `Total Records Read: ${jsonData.length}`;
                    populateFilters();
                    populateDateDropdown();
                    document.getElementById('loadJson').style.display = 'none';
                    document.getElementById('dateFilterContainer').style.display = 'block';
                    const academicYear = new Set(jsonData.map(item => item['Acdmc Year'])).values().next().value;
                    document.getElementById('heading').textContent = `Fee Summary Report - Academic Year ${academicYear}`;
                    enableButtons();
                    addFilterChangeListeners();
                    resetButtonStates();
                } catch (error) {
                    alert('Error parsing JSON file');
                }
            };
            reader.readAsText(file);
        });

        function populateFilters() {
            const filtersContainer = document.getElementById('filters');
            filtersContainer.innerHTML = '';

            for (const [filterName, filterSet] of Object.entries(filters)) {
                filterSet.clear();
                jsonData.forEach(item => {
                    let value = item[filterName];
                    if (filterName === 'Adm Type') {
                        if (['LEFTOUT', 'TR TO', 'LATERAL(ITI)', 'LTRL', 'DUES', 'RPTR2'].some(v => value.includes(v))) {
                            value = value === 'LATERAL(ITI)' ? 'LTRL' : value;
                        } else {
                            value = 'REGULAR';
                        }
                    } else if (filterName === 'Adm Cat') {
                        value = value.includes('SNQ') ? 'SNQ' : 'GM';
                    }
                    if (value) filterSet.add(value);
                });

                const filterGroup = document.createElement('div');
                filterGroup.className = 'filter-group';
                filterGroup.innerHTML = `<h3>${filterName}</h3>`;

                const checkboxContainer = document.createElement('div');
                checkboxContainer.className = 'checkbox-container';

                const allCheckbox = createCheckbox('all', 'All', false);
                allCheckbox.querySelector('input').addEventListener('change', (e) => {
                    checkboxContainer.querySelectorAll('input:not([value="all"])').forEach(cb => {
                        cb.checked = e.target.checked;
                    });
                    updateGetSummaryButtons();
                });
                checkboxContainer.appendChild(allCheckbox);

                filterSet.forEach(value => {
                    const checkbox = createCheckbox(value, value);
                    checkbox.querySelector('input').addEventListener('change', () => {
                        updateAllCheckbox(checkboxContainer);
                        updateGetSummaryButtons();
                    });
                    checkboxContainer.appendChild(checkbox);
                });

                filterGroup.appendChild(checkboxContainer);
                filtersContainer.appendChild(filterGroup);
            }
        }

        function populateDateDropdown() {
            const dateFilter = document.getElementById('dateFilter');
            const dates = new Set(jsonData.map(item => item.Date).filter(date => date));
            dateFilter.innerHTML = '<option value="all">All Dates</option>';
            dates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                dateFilter.appendChild(option);
            });
        }

        function createCheckbox(value, label, isAll = false) {
            const checkboxItem = document.createElement('div');
            checkboxItem.className = 'checkbox-item';
            checkboxItem.innerHTML = `
                <input type="checkbox" id="${value}" value="${value}">
                <label for="${value}">${label}</label>
            `;
            return checkboxItem;
        }

        function updateAllCheckbox(container) {
            const allCheckbox = container.querySelector('input[value="all"]');
            const otherCheckboxes = container.querySelectorAll('input:not([value="all"])');
            allCheckbox.checked = Array.from(otherCheckboxes).every(cb => cb.checked);
        }

    function updateGetSummaryButtons() {
        const allFiltersSelected = Array.from(document.querySelectorAll('.filter-group')).every(group => {
            return Array.from(group.querySelectorAll('input:checked')).length > 0;
        });
        
        const summary1Btn = document.getElementById('getSummary1');
        const summary2Btn = document.getElementById('getSummary2');

        if (!allFiltersSelected) {
            summary1Btn.style.backgroundColor = '#99E6E6'; // Pastel Teal
            summary2Btn.style.backgroundColor = '#99E6E6'; // Pastel Teal
        } else if (filtersChanged) {
            summary1Btn.style.backgroundColor = '#FFD580'; // Pastel Orange
            summary2Btn.style.backgroundColor = '#FFD580'; // Pastel Orange
        }
    }

    function addFilterChangeListeners() {
        document.querySelectorAll('.filter-group input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                filtersChanged = true;
                updateGetSummaryButtons();
            });
        });

        document.getElementById('dateFilter').addEventListener('change', () => {
            filtersChanged = true;
            updateGetSummaryButtons();
        });
    }

    function resetButtonStates() {
        const summary1Btn = document.getElementById('getSummary1');
        const summary2Btn = document.getElementById('getSummary2');
        
        summary1Btn.style.backgroundColor = '#99E6E6'; // Pastel Teal
        summary2Btn.style.backgroundColor = '#99E6E6'; // Pastel Teal
        summary1Btn.classList.remove('active');
        summary2Btn.classList.remove('active');
        summary1Btn.style.color = '#333';
        summary2Btn.style.color = '#333';
        summary1Btn.style.fontWeight = 'normal';
        summary2Btn.style.fontWeight = 'normal';
        filtersChanged = false;
    }

    document.getElementById('getSummary1').addEventListener('click', () => {
        if (areFiltersBlank()) {
            alert('Please select at least one option for each filter');
            return;
        }
        generateSummary(1);
        document.getElementById('getSummary1').style.backgroundColor = '#ADD8E6'; // Pastel Blue
        document.getElementById('getSummary1').classList.add('active');
        document.getElementById('getSummary2').classList.remove('active');
        document.getElementById('getSummary2').style.color = '#333';
        document.getElementById('getSummary2').style.fontWeight = 'normal';
        filtersChanged = false;
    });

    document.getElementById('getSummary2').addEventListener('click', () => {
        if (areFiltersBlank()) {
            alert('Please select at least one option for each filter');
            return;
        }
        generateSummary(2);
        document.getElementById('getSummary2').style.backgroundColor = '#ADD8E6'; // Pastel Blue
        document.getElementById('getSummary2').classList.add('active');
        document.getElementById('getSummary1').classList.remove('active');
        document.getElementById('getSummary1').style.color = '#333';
        document.getElementById('getSummary1').style.fontWeight = 'normal';
        filtersChanged = false;
    });

        document.getElementById('reset').addEventListener('click', () => {
            resetFilters();
            resetButtonStates();
        });

        document.getElementById('savePDF').addEventListener('click', savePDF);

        function generateSummary(summaryType) {
            if (areFiltersBlank()) {
                alert('Please select at least one option for each filter');
                return;
            }

            const selectedFilters = getSelectedFilters();
            const selectedDate = document.getElementById('dateFilter').value;

            const filteredData = jsonData.filter(item => {
                return Object.entries(selectedFilters).every(([key, values]) => {
                    let itemValue = item[key];
                    if (key === 'Adm Type') {
                        if (['LEFTOUT', 'TR TO', 'LATERAL(ITI)', 'LTRL', 'DUES', 'RPTR2'].some(v => itemValue.includes(v))) {
                            itemValue = itemValue === 'LATERAL(ITI)' ? 'LTRL' : itemValue;
                        } else {
                            itemValue = 'REGULAR';
                        }
                    } else if (key === 'Adm Cat') {
                        itemValue = itemValue.includes('SNQ') ? 'SNQ' : 'GM';
                    }
                    return values.includes('all') || values.includes(itemValue);
                }) && (selectedDate === 'all' || item.Date === selectedDate);
            });

            const summaryData = aggregateData(filteredData);
            currentSummaryData = summaryData;
            currentSummaryType = summaryType;
            if (summaryType === 1) {
                displaySummary1(summaryData);
            } else {
                displaySummary2(summaryData);
            }
            displayAppliedFilters(selectedFilters, selectedDate);
        }

        function getSelectedFilters() {
            const selectedFilters = {};
            document.querySelectorAll('.filter-group').forEach(group => {
                const filterName = group.querySelector('h3').textContent;
                const selectedValues = Array.from(group.querySelectorAll('input:checked'))
                    .map(cb => cb.value)
                   .filter(value => value !== 'all');
                selectedFilters[filterName] = selectedValues.length > 0 ? selectedValues : ['all'];
            });
            return selectedFilters;
        }

        function aggregateData(data) {
            const aggregated = {};
            data.forEach(item => {
                const key = item['Reg No'];
                if (!aggregated[key]) {
                    aggregated[key] = {...item};
                    aggregated[key]['Other Fee'] = 0;
                    aggregated[key]['Adm Cat'] = item['Adm Cat'].includes('SNQ') ? 'SNQ' : 'GM';
                    // Calculate Total Paid excluding Ins Policy
                    aggregated[key]['Total Paid'] = (item['Total Paid'] || 0) - (item['Ins Policy'] || 0);
                } else {
                    aggregated[key]['SMP Paid'] += item['SMP Paid'];
                    aggregated[key]['SVK Paid'] += item['SVK Paid'];
                    aggregated[key]['Alloted Fee SMP'] += item['Alloted Fee SMP'];
                    aggregated[key]['Alloted Fee SVK'] += item['Alloted Fee SVK'];
                    aggregated[key]['Tution'] += item['Tution'];
                    // Add to Total Paid excluding Ins Policy
                    aggregated[key]['Total Paid'] += (item['Total Paid'] || 0) - (item['Ins Policy'] || 0);
                }
                ['Adm', 'Lib', 'RR', 'Sports', 'Lab', 'DVP', 'Mag', 'ID', 'Ass', 'SWF', 'TWF', 'NSS', 'Fine'].forEach(fee => {
                    aggregated[key]['Other Fee'] += item[fee] || 0;
                });
            });
            return Object.values(aggregated);
        }

        function displaySummary1(data) {
            const summaryContainer = document.getElementById('summary');
            summaryContainer.innerHTML = '';

            if (data.length === 0) {
                summaryContainer.innerHTML = '<p>No data matches the selected filters.</p>';
                return;
            }

            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            // Define columns
            const columns = [
                'Sl No', 'Student Name', 'Year', 'Course', 'Reg No', 'Cat', 'Adm Type', 'Adm Cat', 'Date', 'Rpt',
                'Allot SMP', 'Allot SVK', 'SMP Paid', 'SVK Paid', 'Tution', 'Other Fee', 'Total Paid', 'Acdmc Year'
            ];

            // Calculate totals
            const totals = columns.reduce((acc, col) => {
                acc[col] = 0;
                return acc;
            }, {});

            // Create data rows and calculate totals
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                columns.forEach(col => {
                    const td = document.createElement('td');
                    if (col === 'Sl No') {
                        td.textContent = index + 1;
                    } else if (['Allot SMP', 'Allot SVK', 'SMP Paid', 'SVK Paid', 'Tution', 'Other Fee', 'Total Paid'].includes(col)) {
                        const value = col === 'Allot SMP' ? item['Alloted Fee SMP'] :
                                      col === 'Allot SVK' ? item['Alloted Fee SVK'] :
                                      item[col];
                        td.textContent = value.toFixed(2);
                        td.className = 'number';
                        totals[col] += value;
                    } else if (col === 'Adm Cat') {
                        td.textContent = item[col].includes('SNQ') ? 'SNQ' : 'GM';
                    } else {
                        td.textContent = item[col] || '';
                    }
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });

            // Create totals row
            const totalsRow = document.createElement('tr');
            totalsRow.className = 'total-row';
            columns.forEach(col => {
                const td = document.createElement('td');
                if (col === 'Sl No') {
                    td.textContent = 'Total';
                } else if (col === 'Student Name') {
                    td.textContent = data.length;
                } else if (['Allot SMP', 'Allot SVK', 'SMP Paid', 'SVK Paid', 'Tution', 'Other Fee', 'Total Paid'].includes(col)) {
                    td.textContent = totals[col].toFixed(2);
                    td.className = 'number';
                }
                totalsRow.appendChild(td);
            });

            // Create header row
            const headerRow = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });

            // Append rows to table in the correct order
            thead.appendChild(totalsRow);
            thead.appendChild(headerRow);
            table.appendChild(thead);
            table.appendChild(tbody);
            summaryContainer.appendChild(table);
        }

        function displaySummary2(data) {
            const summaryContainer = document.getElementById('summary');
            summaryContainer.innerHTML = '';

            if (data.length === 0) {
                summaryContainer.innerHTML = '<p>No data matches the selected filters.</p>';
                return;
            }

            // Sort data by Year, Course, and Student Name
            data.sort((a, b) => {
                if (a.Year !== b.Year) return a.Year.localeCompare(b.Year);
                if (a.Course !== b.Course) return a.Course.localeCompare(b.Course);
                return a['Student Name'].localeCompare(b['Student Name']);
            });

            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            // Define columns
            const columns = [
                'Sl No', 'Student Name', 'Year', 'Course', 'Reg No', 'Cat', 'Adm Type', 'Adm Cat', 'Date', 'Rpt',
                'Allot SMP', 'Allot SVK', 'SMP Paid', 'SVK Paid', 'Bal SMP', 'Bal SVK', 'Total Allot', 'Total Paid', 'Total Bal', 'Acdmc Year'
            ];

            // Calculate totals
            const totals = columns.reduce((acc, col) => {
                acc[col] = 0;
                return acc;
            }, {});

            // Create data rows and calculate totals
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                columns.forEach(col => {
                    const td = document.createElement('td');
                    if (col === 'Sl No') {
                        td.textContent = index + 1;
                    } else if (['Allot SMP', 'Allot SVK', 'SMP Paid', 'SVK Paid', 'Bal SMP', 'Bal SVK', 'Total Allot', 'Total Paid', 'Total Bal'].includes(col)) {
                        let value;
                        switch (col) {
                            case 'Allot SMP':
                                value = item['Alloted Fee SMP'];
                                break;
                            case 'Allot SVK':
                                value = item['Alloted Fee SVK'];
                                break;
                            case 'SMP Paid':
                                value = Math.min(item['SMP Paid'], item['Alloted Fee SMP']);
                                break;
                            case 'SVK Paid':
                                value = item['SVK Paid'];
                                break;
                            case 'Bal SMP':
                                value = Math.max(0, item['Alloted Fee SMP'] - Math.min(item['SMP Paid'], item['Alloted Fee SMP']));
                                break;
                            case 'Bal SVK':
                                value = Math.max(0, item['Alloted Fee SVK'] - item['SVK Paid']);
                                break;
                            case 'Total Allot':
                                value = item['Alloted Fee SMP'] + item['Alloted Fee SVK'];
                                break;
                            case 'Total Paid':
                                value = Math.min(item['SMP Paid'], item['Alloted Fee SMP']) + item['SVK Paid'];
                                break;
                            case 'Total Bal':
                                value = (item['Alloted Fee SMP'] + item['Alloted Fee SVK']) - 
                                        (Math.min(item['SMP Paid'], item['Alloted Fee SMP']) + item['SVK Paid']);
                                break;
                        }
                        td.textContent = value.toFixed(2);
                        td.className = 'number';
                        totals[col] += value;
                    } else if (col === 'Adm Cat') {
                        td.textContent = item[col].includes('SNQ') ? 'SNQ' : 'GM';
                    } else {
                        td.textContent = item[col] || '';
                    }
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });

            // Create totals row
            const totalsRow = document.createElement('tr');
            totalsRow.className = 'total-row';
            columns.forEach(col => {
                const td = document.createElement('td');
                if (col === 'Sl No') {
                    td.textContent = 'Total';
                } else if (col === 'Student Name') {
                    td.textContent = data.length;
                } else if (['Allot SMP', 'Allot SVK', 'SMP Paid', 'SVK Paid', 'Bal SMP', 'Bal SVK', 'Total Allot', 'Total Paid', 'Total Bal'].includes(col)) {
                    td.textContent = totals[col].toFixed(2);
                    td.className = 'number';
                }
                totalsRow.appendChild(td);
            });

            // Create header row
            const headerRow = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });

            // Append rows to table in the correct order
            thead.appendChild(totalsRow);
            thead.appendChild(headerRow);
            table.appendChild(thead);
            table.appendChild(tbody);
            summaryContainer.appendChild(table);
        }

        function displayAppliedFilters(filters, selectedDate) {
            const appliedFiltersContainer = document.getElementById('appliedFilters');
            appliedFiltersContainer.innerHTML = '<strong>Applied Filters:</strong> ';
            appliedFiltersContainer.innerHTML += Object.entries(filters)
                .map(([key, values]) => `${key}: ${values.join(', ')}`)
                .join(' | ');
            appliedFiltersContainer.innerHTML += ` | Date: ${selectedDate}`;
        }

        function resetFilters() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('dateFilter').value = 'all';
            document.getElementById('summary').innerHTML = '';
            document.getElementById('appliedFilters').innerHTML = '';
            resetButtonStates();
        }

        function areFiltersBlank() {
            const filterGroups = document.querySelectorAll('.filter-group');
            for (let group of filterGroups) {
                if (Array.from(group.querySelectorAll('input:checked')).length === 0) {
                    return true;
                }
            }
            return false;
        }

        function enableButtons() {
            document.getElementById('getSummary1').disabled = false;
            document.getElementById('getSummary2').disabled = false;
            document.getElementById('savePDF').disabled = false;
        }

        function savePDF() {
            if (currentSummaryData.length === 0) {
                alert('Please generate a summary before saving as PDF.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'pt', 'a4');
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;

            // Add heading
            doc.setFontSize(14);
            doc.text(document.getElementById('heading').textContent, margin, margin + 10);

            // Add applied filters
            doc.setFontSize(8);
            doc.text(document.getElementById('appliedFilters').textContent, margin, margin + 25);

            // Define columns based on summary type
            const columns = currentSummaryType === 1 ?
                ['Sl No', 'Student Name', 'Year', 'Course', 'Reg No', 'Cat', 'Adm Type', 'Adm Cat', 'Date', 'Rpt', 'Allot SMP', 'Allot SVK', 'SMP Paid', 'SVK Paid', 'Tution', 'Other Fee', 'Total Paid', 'Acdmc Year'] :
                ['Sl No', 'Student Name', 'Year', 'Course', 'Reg No', 'Cat', 'Adm Type', 'Adm Cat', 'Date', 'Rpt', 'Allot SMP', 'Allot SVK', 'SMP Paid', 'SVK Paid', 'Bal SMP', 'Bal SVK', 'Total Allot', 'Total Paid', 'Total Bal', 'Acdmc Year'];

            // Prepare data for autotable
            const body = currentSummaryData.map((item, index) => {
                return columns.map(col => {
                    if (col === 'Sl No') return index + 1;
                    if (col === 'Adm Cat') return item[col].includes('SNQ') ? 'SNQ' : 'GM';
                    if (['Allot SMP', 'Allot SVK', 'SMP Paid', 'SVK Paid', 'Tution', 'Other Fee', 'Total Paid', 'Bal SMP', 'Bal SVK', 'Total Allot', 'Total Bal'].includes(col)) {
                        let value;
                        switch (col) {
                            case 'Allot SMP':
                                value = item['Alloted Fee SMP'];
                                break;
                            case 'Allot SVK':
                                value = item['Alloted Fee SVK'];
                                break;
                            case 'SMP Paid':
                                value = Math.min(item['SMP Paid'], item['Alloted Fee SMP']);
                                break;
                            case 'SVK Paid':
                                value = item['SVK Paid'];
                                break;
                            case 'Bal SMP':
                                value = Math.max(0, item['Alloted Fee SMP'] - Math.min(item['SMP Paid'], item['Alloted Fee SMP']));
                                break;
                            case 'Bal SVK':
                                value = Math.max(0, item['Alloted Fee SVK'] - item['SVK Paid']);
                                break;
                            case 'Total Allot':
                                value = item['Alloted Fee SMP'] + item['Alloted Fee SVK'];
                                break;
                            case 'Total Paid':
                                value = Math.min(item['SMP Paid'], item['Alloted Fee SMP']) + item['SVK Paid'];
                                break;
                            case 'Total Bal':
                                value = (item['Alloted Fee SMP'] + item['Alloted Fee SVK']) - 
                                        (Math.min(item['SMP Paid'], item['Alloted Fee SMP']) + item['SVK Paid']);
                                break;
                            default:
                                value = item[col];
                        }
                        return typeof value === 'number' ? value.toFixed(2) : value;
                    }
                    return item[col] || '';
                });
            });

            // Calculate totals
            const totals = columns.map(col => {
                if (['Allot SMP', 'Allot SVK', 'SMP Paid', 'SVK Paid', 'Tution', 'Other Fee', 'Total Paid', 'Bal SMP', 'Bal SVK', 'Total Allot', 'Total Bal'].includes(col)) {
                    return body.reduce((sum, row) => sum + parseFloat(row[columns.indexOf(col)] || 0), 0).toFixed(2);
                }
                return '';
            });
            totals[0] = 'Total';
            totals[1] = currentSummaryData.length;

            // Add autotable
            doc.autoTable({
                head: [columns],
                body: [totals, ...body],
                startY: margin + 40,
                styles: { fontSize: 6, cellPadding: 1 },
                headStyles: { fillColor: [242, 242, 242], textColor: [0, 0, 0], fontStyle: 'bold' },
                columnStyles: {
                    0: { cellWidth: 25 }, // Sl No
                    1: { cellWidth: 70 }, // Student Name
                    2: { cellWidth: 25 }, // Year
                    3: { cellWidth: 25 }, // Course
                    4: { cellWidth: 30 }, // Reg No
                    5: { cellWidth: 20 }, // Cat
                    6: { cellWidth: 30 }, // Adm Type
                    7: { cellWidth: 25 }, // Adm Cat
                    8: { cellWidth: 40 }, // Date
                    9: { cellWidth: 25 }, // Rpt
                },
                didDrawPage: function (data) {
                    // Footer
                    doc.setFontSize(8);
                    doc.text('Page ' + doc.internal.getNumberOfPages(), pageWidth - margin - 40, pageHeight - margin);
                },
                didParseCell: function(data) {
                    if (data.section === 'body' && typeof data.cell.raw === 'number') {
                        data.cell.styles.halign = 'right';
                    }
                },
            });

            // Save the PDF
            doc.save(`Fee_Summary_Report_${currentSummaryType}.pdf`);
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('getSummary1').disabled = true;
            document.getElementById('getSummary2').disabled = true;
            document.getElementById('savePDF').disabled = true;
        });
    </script>
</body>
</html>